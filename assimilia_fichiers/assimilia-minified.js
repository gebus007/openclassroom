var Quizz=new Class({Implements:[Options,Events],options:{title:"Quizz title",solutions:new Array,solutionsKeys:new Array,toBeShuffled:!0,nbSecondsClues:5,pointsPerGoodAnswer:5,comboMax:3,trainingLbl:"Training",difficulty1Lbl:"Easy",difficulty2Lbl:"Medium",difficulty3Lbl:"Hard",questionContext:"Question to ask",countdownPrefix:"",countdownSuffix:"",countdownFinalMsg:"",countdownCluesPrefix:"",countdownCluesSuffix:"",countdownCluesFinalMsg:"",availableCluesThresold:5,okLbl:"OK",resultTitle:"Results",scoreMsg:"Score : ",completedMsg:"Quizz completed !",congratulationMsg:"Congratulation !",nbFaultsMsg:"Faults done :",finalSolutionMsg:"",statsCorrects:"Corrects",statsFaults:"Faults",statsRemaining:"Remaining",resetBtnLbl:"Restart"},initialize:function(t){this.setOptions(t),this.reset(),this.createZoomPanel()},reset:function(){this.index=0,this.isCompleted=!1,this.length=this.options.solutions.length,this.score=0,this.combo=0,this.setLevel(1),this.createIndicatorPanel(),this.createQuestionPanel(),this.removeResults(),this.solutionsLayout=new Array;for(var t=0;t<this.length;t++)this.solutionsLayout[t]=t;this.options.toBeShuffled&&this.solutionsLayout.shuffle();for(var e,t=0;t<this.length;t++)e=this.getSolutionKey(t),$(e).setAttribute("onclick",""),$(e).setAttribute("class","base"),$(e).setAttribute("title",""),$(e).setStyle("cursor","auto");this.wrongAnswers=new Array,this.clues=new Array,this.domEndGamePanel=null},start:function(t){this.setLevel(t);for(var e,s=0;s<this.length;s++)e=this.getSolutionKey(s),$(e).addEvent("click",function(t){this.checkAnswer(t.target.id)}.bind(this));if(!this.isTraining()){var i=this;this.countdown=new Countdown({durationInSeconds:i.getDurationInSeconds(),fctToDo:function(){i.endQuizz()},gui:i.getDomCountdown(),txtPrefix:i.options.countdownPrefix,txtSuffix:i.options.countdownSuffix}),this.countdown.start()}this.askQuestion()},checkAnswer:function(t){var e=this.getCurrentSolutionKey();this.index>0&&"correction"==$(this.getSolutionKey(this.index-1)).getAttribute("class")&&$(this.getSolutionKey(this.index-1)).setAttribute("class","base"),t==e?($(t).setAttribute("class","correct"),$(t).setAttribute("onclick",""),this.isTraining()||(this.setScore(this.getScore()+this.options.pointsPerGoodAnswer+this.getCombo()),this.refreshScore(),this.getCombo()<this.options.comboMax&&(this.setCombo(this.getCombo()+1),this.refreshCombo()),this.countdown.addTime(this.getNbSecondsBonus()))):($(e).setAttribute("class","correction"),this.wrongAnswers.push(e),this.isTraining()||(this.setCombo(0),this.refreshCombo())),this.nextQuestion()},nextQuestion:function(){this.removeOldClues(),this.index=this.index+1,this.index==this.length?(this.isCompleted=!0,this.endQuizz()):this.askQuestion()},askQuestion:function(){this.displayQuestionNb(this.index+1+"/"+this.length),this.displayQuestionContext(this.options.questionContext),this.displayQuestionSpot(this.getCurrentSolution()),this.prepareClues()},prepareClues:function(){var t=new Array,e=!1;this.createCluesBtn(),this.getDomCluesBtn().disabled=!0;for(var s=0;s<this.wrongAnswers.length;s++)t.push(this.wrongAnswers[s]);for(var s=this.index;s<this.length;s++)t.push(this.getSolutionKey(s));if(t.length>=this.options.nbCluesGiven-1){this.clues.push(this.getCurrentSolutionKey()),t.shuffle();for(var s=0;s<this.options.nbCluesGiven-1;s++)this.clues.push(t[s]);this.countdownClues.start(),e=!0}return e},showClues:function(){this.destroyCluesBtn();for(var t=0;t<this.clues.length;t++)$(this.clues[t]).setAttribute("class","clue")},removeOldClues:function(){this.countdownClues&&this.countdownClues.stop();for(var t=0;t<this.clues.length;t++)"clue"==$(this.clues[t]).getAttribute("class")&&$(this.clues[t]).setAttribute("class","base");this.clues.empty()},endQuizz:function(){{var t="";this.wrongAnswers.length}this.isCompleted&&!this.isTraining()?this.countdown.stop():$(this.getCurrentSolutionKey()).setAttribute("class","correction"),this.getDomCluesBtn().dispose();for(var e=0;e<this.length;e++)$(this.getSolutionKey(e)).setAttribute("onclick",""),$(this.getSolutionKey(e)).setAttribute("title",this.getSolution(e));t=this.isCompleted?this.options.completedMsg:this.options.countdownFinalMsg,this.createEndGamePanel(t)},showResults:function(){for(var t=0;t<this.wrongAnswers.length;t++)$(this.wrongAnswers[t]).setAttribute("class","correction");this.showTips(),$$(".base, .correction, .correct, .notused").setStyle("cursor","help");var e=$("indicatorPanel").getPosition();this.destroyEndGamePanel(),this.destroyQuestionPanel(),this.destroyIndicatorPanel(),this.createResultsPanel(e)},removeResults:function(){this.destroyResultsPanel(),$$(".base, .correction, .correct, .notused").setStyle("cursor","auto"),$$(".base, .correction, .correct, .notused").setStyle("title",""),this.hideTips()},showTips:function(){this.tips?$(".map_tip").setStyle("visibility","visible"):this.tips=new Tips($(".base, .correction, .correct, .notused"),{className:"map_tip"})},hideTips:function(){this.tips&&$(".map_tip").setStyle("visibility","hidden")},createIndicatorPanel:function(){var t=Elements.from("<div id='indicatorPanel' class='quizzPanel'><table width='100%' ><tr><td>Temps</td><td>Combo</td><td>Points</td></tr><tr><td><span id='countdown'></span></td><td><span id='combo'><svg width='70' height='21' xmlns='http://www.w3.org/2000/svg'><desc>Combo</desc><defs><style type='text/css'></style></defs><g transform='translate(-0.49623481,-5.4041983)'><path class='star starEmpty' id='star1' d='M 17.450831,20.63857 6.183341,16.756863 -3.4020285,23.838152 -3.1921512,11.922619 -12.8889,4.9946296 -1.4916985,1.5121325 2.1007508,-9.8508898 8.9347312,-0.08765816 20.851736,-0.18240279 13.678167,9.3341033 z' transform='matrix(0.60916408,0.08615325,-0.08615325,0.60916408,8.7779931,11.80156)' /><path class='star starEmpty'id='star2'd='M 17.450831,20.63857 6.183341,16.756863 -3.4020285,23.838152 -3.1921512,11.922619 -12.8889,4.9946296 -1.4916985,1.5121325 2.1007508,-9.8508898 8.9347312,-0.08765816 20.851736,-0.18240279 13.678167,9.3341033 z' transform='matrix(0.60916408,0.08615325,-0.08615325,0.60916408,33.029307,11.623748)'/><path class='star starEmpty' id='star3' d='M 17.450831,20.63857 6.183341,16.756863 -3.4020285,23.838152 -3.1921512,11.922619 -12.8889,4.9946296 -1.4916985,1.5121325 2.1007508,-9.8508898 8.9347312,-0.08765816 20.851736,-0.18240279 13.678167,9.3341033 z' transform='matrix(0.60916408,0.08615325,-0.08615325,0.60916408,57.479515,11.22402)' /></g></svg></span></td><td><span id='score'>0</span></td></tr></table></div>");$(document.body).adopt(t),this.setDomIndicatorPanel($("indicatorPanel")),this.setDomCountdown($("countdown")),this.setDomScore($("score")),this.setDomCombo($("combo"));{var e=($("map").getPosition(),$("map").getSize());new Drag.Move(this.getDomIndicatorPanel(),{})}this.getDomIndicatorPanel().setStyle("top",e.y/2-170+"px"),this.getDomIndicatorPanel().setStyle("left","10px")},destroyIndicatorPanel:function(){this.getDomIndicatorPanel().dispose(),this.setDomIndicatorPanel(null)},createQuestionPanel:function(){var t=new Element("div",{id:"questionPanel","class":"quizzPanel"});$(document.body).adopt(t),this.setDomQuestionPanel($("questionPanel"));{var e=($("map").getPosition(),$("map").getSize());new Drag.Move($("questionPanel"),{})}this.getDomQuestionPanel().setStyle("top",e.y/2-100+"px"),this.getDomQuestionPanel().setStyle("left","10px");var s=new Element("div",{id:"questionHeader"});s.textContent=this.options.title,this.getDomQuestionPanel().adopt(s);var i=new Element("div",{id:"questionBody"});this.getDomQuestionPanel().adopt(i);var n=new Element("div",{id:"questionContext"});i.adopt(n);var o=new Element("div",{id:"questionSpot"});i.adopt(o);var a=new Element("button",{id:"startBtn0","class":"quizzBtn",text:this.options.trainingLbl});a.addEvent("click",function(){this.start(0)}.bind(this)),o.adopt(a);var l=new Element("button",{id:"startBtn1","class":"quizzBtn",text:this.options.difficulty1Lbl});l.addEvent("click",function(){this.start(1)}.bind(this)),o.adopt(l);var r=new Element("button",{id:"startBtn2","class":"quizzBtn",text:this.options.difficulty2Lbl});r.addEvent("click",function(){this.start(2)}.bind(this)),o.adopt(r);var u=new Element("button",{id:"startBtn3","class":"quizzBtn",text:this.options.difficulty3Lbl});u.addEvent("click",function(){this.start(3)}.bind(this)),o.adopt(u);var h=new Element("table",{id:"questionFooter"});this.getDomQuestionPanel().adopt(h);var d=new Element("tr",{});h.adopt(d),d.adopt(new Element("td",{id:"cluePanel"})),d.adopt(new Element("td",{id:"questionNb"}))},destroyQuestionPanel:function(){this.domQuestionPanel.dispose(),this.setDomQuestionPanel(null)},createCluesBtn:function(){if(!this.getDomCluesBtn()){var t=new Element("button",{id:"cluesBtn","class":"quizzBtn",disabled:"disabled",text:this.options.countdownCluesFinalMsg});t.addEvent("click",function(){this.showClues()}.bind(this)),$("cluePanel").adopt(t),this.setDomCluesBtn($("cluesBtn"));var e=this;this.countdownClues=new Countdown({durationInSeconds:e.options.nbSecondsClues,fctToDo:function(){e.enableCluesBtn()},gui:e.getDomCluesBtn(),txtPrefix:e.options.countdownCluesPrefix,txtSuffix:e.options.countdownCluesSuffix})}},destroyCluesBtn:function(){this.countdownClues.stop(),this.getDomCluesBtn().dispose(),this.setDomCluesBtn(null)},enableCluesBtn:function(){this.getDomCluesBtn()&&(this.getDomCluesBtn().textContent=this.options.countdownCluesFinalMsg,this.getDomCluesBtn().disabled=!1)},createEndGamePanel:function(t){var e=new Element("div",{id:"endGamePanel","class":"quizzPanel"});$(document.body).adopt(e),this.domEndGamePanel=$("endGamePanel");{var s=$("map").getPosition(),i=$("map").getSize();new Drag.Move($("endGamePanel"),{})}$("endGamePanel").setStyle("left",s.x+Math.round(i.x/2)-125+"px"),$("endGamePanel").setStyle("top",s.y+Math.round(i.y/2)-10+"px"),this.domEndGamePanel.textContent=t;var n=new Element("button",{id:"resultsBtn","class":"quizzBtn",text:this.options.okLbl,style:"display:block;"});n.addEvent("click",function(){this.showResults()}.bind(this)),this.domEndGamePanel.adopt(n)},destroyEndGamePanel:function(){this.domEndGamePanel.dispose(),this.domEndGamePanel=null},createResultsPanel:function(t){var e=this.wrongAnswers.length,s=new Element("div",{id:"resultsPanel","class":"quizzPanel"});$(document.body).adopt(s),this.setDomResultsPanel($("resultsPanel"));new Drag.Move($("resultsPanel"),{});this.getDomResultsPanel().setStyle("left",t.x+"px"),this.getDomResultsPanel().setStyle("top",t.y+"px"),this.domResultsPanel.adopt(new Element("div",{id:"resultsHeader"})),$("resultsHeader").textContent=this.options.resultTitle,this.domResultsPanel.adopt(new Element("p",{text:this.options.scoreMsg+this.getScore()})),this.isTraining()||(this.domResultsPanel.adopt(new Element("p",{text:this.options.remainingTimeMsg+Math.ceil(this.getRemainingTime()/1e3)})),this.setScore(this.getScore()+Math.ceil(this.getRemainingTime()/1e3)),this.domResultsPanel.adopt(new Element("p",{text:this.options.finalScoreTimeMsg+this.getScore()}))),this.isCompleted&&0==e?this.domResultsPanel.adopt(new Element("p",{text:this.options.congratulationMsg})):(this.domResultsPanel.adopt(new Element("p",{text:this.options.nbFaultsMsg+e+". "})),e>0&&this.domResultsPanel.adopt(new Element("p",{text:this.options.finalSolutionMsg})));var i=new HtmlTable({properties:{id:"tableResults",summary:"Résultats"},headers:[this.options.statsCorrects,this.options.statsFaults,this.options.statsRemaining],rows:[[this.index-this.wrongAnswers.length,this.wrongAnswers.length,this.length-this.index]]});this.domResultsPanel.adopt(i),new MilkChart.Pie("tableResults",{width:250,height:160,padding:10,fontSize:10,border:!1});var n=new Element("button",{id:"resetBtn","class":"quizzBtn",text:this.options.resetBtnLbl});n.addEvent("click",function(){this.reset()}.bind(this)),this.domResultsPanel.adopt(n)},destroyResultsPanel:function(){this.getDomResultsPanel()&&(this.getDomResultsPanel().dispose(),this.setDomResultsPanel(null))},createZoomPanel:function(){this.scale=4;var t=new Element("div",{id:"zoomPanel","class":"quizzPanel"});$(document.body).adopt(t),this.domZoomPanel=$("zoomPanel");$("map").getPosition(),$("map").getSize(),new Drag.Move($("zoomPanel"),{});$("zoomPanel").setStyle("left","10px"),$("zoomPanel").setStyle("top","10px");var e=Elements.from('<svg height="208" width="250" stroke-opacity="0.8" style="z-index: 18; position: absolute;"><g><line class="lineSVG" y2="104" x2="95" y1="104" x1="119" style="stroke: rgb(255, 0, 0); stroke-width: 2px;" /><line class="lineSVG" y2="104" x2="121" y1="104" x1="129" style="stroke: rgb(255, 0, 0); stroke-width: 1px;" /><line class="lineSVG" y2="104" x2="131" y1="104" x1="155" style="stroke: rgb(255, 0, 0); stroke-width: 2px;" /><line class="lineSVG" y2="74" x2="125" y1="98" x1="125" style="stroke: rgb(255, 0, 0); stroke-width: 2px;" /><line class="lineSVG" y2="100" x2="125" y1="108" x1="125" style="stroke: rgb(255, 0, 0); stroke-width: 1px;" /><line class="lineSVG" y2="110" x2="125" y1="134" x1="125" style="stroke: rgb(255, 0, 0); stroke-width: 2px;" /></g></svg>');this.domZoomPanel.adopt(e),this.mapWidth=$("mapsvg").getAttribute("width"),this.mapHeight=$("mapsvg").getAttribute("height"),this.mapViewBox=$("mapsvg").getAttribute("viewBox"),this.zoomMapWidth=parseInt($("questionPanel").getStyle("width").replace("px","")),this.zoomMapRatio=this.zoomMapWidth/this.mapWidth,this.zoomMapHeight=Math.round(this.zoomMapRatio*this.mapHeight);var s=this.mapViewBox.split(" ");this.viewBoxHorizontalPan=parseFloat(s[0]),this.viewBoxVerticalPan=parseFloat(s[1]),this.zoomMapDimX=s[2]*this.zoomMapRatio,this.zoomMapDimY=s[3]*this.zoomMapRatio;var i=s[0]+" "+s[1]+" "+this.zoomMapDimX+" "+this.zoomMapDimY;this.domMapSvgZoom=$("mapsvg").clone(!0,!0),this.domMapSvgZoom.setAttribute("width",this.zoomMapWidth),this.domMapSvgZoom.setAttribute("height",this.zoomMapHeight),this.domMapSvgZoom.setAttribute("viewBox",i),this.mapSvgZoomTransMatrix=[1,0,0,1,0,0],this.zoomMap(4),this.domZoomPanel.adopt(this.domMapSvgZoom),$("mapsvg").addEvent("mousemove",function(t){this.displayZoom(t)}.bind(this));for(var n,o=0;o<this.length;o++)n=this.getSolutionKey(o),$("map").getElements("#"+n).addEvents({mouseover:function(t){this.zoomMouseOver(t)}.bind(this),mouseleave:function(t){$("zoomPanel").getElement("#"+t.target.id).removeClass("zoomOver")}})},zoomMouseOver:function(t){var e=$("zoomPanel").getElement("#"+t.target.id),s=e.getAttribute("class");e.removeClass(s),e.addClass("zoomOver"),e.addClass(s)},zoomMap:function(t){this.scale=t;for(var e=0;e<this.mapSvgZoomTransMatrix.length;e++)this.mapSvgZoomTransMatrix[e]*=t;this.mapSvgZoomTransMatrix[4]+=(1-t)*this.zoomMapWidth/2,this.mapSvgZoomTransMatrix[5]+=(1-t)*this.zoomMapHeight/2;var s="matrix("+this.mapSvgZoomTransMatrix.join(" ")+")";this.domMapSvgZoom.getElement("g").setAttribute("transform",s)},displayZoom:function(t){this.zoomSvgPnt||(this.zoomSvgPnt=$("mapsvg").createSVGPoint()),this.zoomSvgPnt.x=t.event.clientX,this.zoomSvgPnt.y=t.event.clientY;var e=this.zoomSvgPnt.matrixTransform(t.target.getScreenCTM().inverse());this.domMapSvgZoom.setAttribute("viewBox",e.x-this.zoomMapDimX/2+" "+(e.y-this.zoomMapDimY/2)+" "+this.zoomMapDimX+" "+this.zoomMapDimY),this.mapSvgZoomTransMatrix[4]=e.x*(1-this.scale),this.mapSvgZoomTransMatrix[5]=e.y*(1-this.scale),this.domMapSvgZoom.getElement("g").setAttribute("transform","matrix("+this.mapSvgZoomTransMatrix.join(" ")+")")},refreshScore:function(){this.getDomScore().textContent=this.score},refreshCombo:function(){for(var t=1;t<this.options.comboMax+1;t++)t<=this.getCombo()?$("star"+t).setAttribute("class","star starFullLevel"+this.getLevel()):$("star"+t).setAttribute("class","star starEmpty")},displayQuestionNb:function(t){$("questionNb").textContent=t},displayQuestionContext:function(t){$("questionContext").textContent=t},displayQuestionSpot:function(t){$("questionSpot").textContent=t},isTraining:function(){return 0==this.getLevel()},getSolution:function(t){return this.options.solutions[this.solutionsLayout[t]]},getCurrentSolution:function(){return this.getSolution(this.index)},getSolutionKey:function(t){return this.options.solutionsKeys[this.solutionsLayout[t]]},getCurrentSolutionKey:function(){return this.getSolutionKey(this.index)},getLevel:function(){return this.level},getScore:function(){return this.score},getCombo:function(){return this.combo},getDurationInSeconds:function(){return this.durationInSeconds},getNbSecondsBonus:function(){return this.nbSecondsBonus},getRemainingTime:function(){return this.countdown.getRemainingTime()},getDomIndicatorPanel:function(){return this.domIndicatorPanel},getDomCountdown:function(){return this.domCountdown},getDomScore:function(){return this.domScore},getDomCombo:function(){return this.domCombo},getDomQuestionPanel:function(){return this.domQuestionPanel},getDomCluesBtn:function(){return this.domCluesBtn},getDomResultsPanel:function(){return this.domResultsPanel},setLevel:function(t){switch(this.level=t,t){case 1:this.setDurationInSeconds(Math.max(3*this.length,15)),this.setNbSecondsBonus(2);break;case 2:this.setDurationInSeconds(Math.max(2*this.length,15)),this.setNbSecondsBonus(2);break;case 3:this.setDurationInSeconds(Math.max(1*this.length,15)),this.setNbSecondsBonus(2)}},setScore:function(t){this.score=t},setDurationInSeconds:function(t){this.durationInSeconds=t},setNbSecondsBonus:function(t){this.nbSecondsBonus=t},setCombo:function(t){this.combo=t},setDomIndicatorPanel:function(t){this.domIndicatorPanel=t},setDomCountdown:function(t){this.domCountdown=t},setDomScore:function(t){this.domScore=t},setDomCombo:function(t){this.domCombo=t},setDomQuestionPanel:function(t){this.domQuestionPanel=t},setDomCluesBtn:function(t){this.domCluesBtn=t},setDomResultsPanel:function(t){this.domResultsPanel=t}}),Countdown=new Class({Implements:[Options,Events],options:{durationInSeconds:10,fctToDo:function(){alert("end countdown !")},txtPrefix:"",txtSuffix:""},initialize:function(t){this.setOptions(t),this.timerId=null,this.toStop=!1,this.remainingTime=this.durationInSeconds},start:function(){this.toStop=!1,this.startTime=new Date,this.endTime=new Date,this.endTime.setSeconds(this.endTime.getSeconds()+this.options.durationInSeconds),this.run()},run:function(){this.toStop?clearTimeout(this.timerId):(this.refreshRemainingTime(),this.options.gui&&(this.options.gui.textContent=this.options.txtPrefix+Math.ceil(this.remainingTime/1e3)+this.options.txtSuffix),this.remainingTime>0?this.timerID=setTimeout(this.run.bind(this),10):this.options.fctToDo())},stop:function(){this.refreshRemainingTime(),this.toStop=!0},addTime:function(t){this.endTime.setSeconds(this.endTime.getSeconds()+t),this.remainingTime+=1e3*t},refreshRemainingTime:function(){var t=new Date;this.remainingTime=Math.max(this.endTime-t,0)},getRemainingTime:function(){return this.remainingTime}});